{% extends "base.html" %} {% block content %}
<div class="grid gap-6">
  <div class="p-5 bg-white border rounded-xl shadow-sm">
    <h2 class="font-semibold text-lg mb-3">Kirim Email Promosi</h2>
    <form method="post" action="/send" class="grid gap-4">
      <div class="grid gap-2">
        <label class="text-sm font-medium">Subject</label>
        <input
          name="subject"
          class="border rounded-lg p-2"
          placeholder="Promo Spesial Minggu Ini"
          required
        />
      </div>

      <div class="grid gap-2">
        <label for="image_upload" class="text-sm font-medium"
          >Upload Gambar</label
        >
        <input
          type="file"
          id="image_upload"
          accept="image/*"
          class="text-sm border border-gray-300 rounded p-1"
        />

        <img
          id="image_preview"
          alt="Preview gambar"
          class="mt-2 w-48 h-48 object-contain border rounded hidden"
        />

        <input type="hidden" name="image_url" id="image_url" />

        <label for="body_html" class="text-sm font-medium mt-2"
          >HTML Body</label
        >
        <div class="border border-gray-300 rounded-lg overflow-hidden">
          <div id="editor" class="min-h-[150px]"></div>
        </div>
        <textarea name="body_html" id="body_html" hidden></textarea>
        <p class="text-xs text-slate-500">
          Gunakan HTML sederhana. Unsubscribe ditambahkan otomatis di footer.
        </p>
      </div>

      <div class="grid gap-2">
        <label class="text-sm font-medium"
          >Manual Recipients (comma/line)</label
        >
        <textarea
          name="recipients"
          class="border rounded-lg p-2 h-24"
          placeholder="user1@example.com, user2@example.com"
        ></textarea>
      </div>

      <div class="flex items-center gap-2">
        <input
          id="use_audience"
          name="use_audience"
          type="checkbox"
          class="h-4 w-4"
        />
        <label for="use_audience" class="text-sm"
          >Tambahkan semua subscriber aktif dari database ({{ active_count }}
          orang)</label
        >
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="grid gap-2 p-3 border rounded-lg">
          <div class="text-sm font-medium">Test Send</div>
          <input
            name="test_email"
            class="border rounded-lg p-2"
            placeholder="email-kamu@contoh.com"
          />
          <button
            name="mode"
            value="test"
            class="mt-2 px-3 py-2 rounded-lg bg-slate-900 text-white"
          >
            Kirim Test
          </button>
          <p class="text-xs text-slate-500">
            Kirim hanya ke 1 alamat untuk uji coba.
          </p>
        </div>
        <div class="grid gap-2 p-3 border rounded-lg">
          <div class="text-sm font-medium">Kirim Kampanye</div>
          <button
            name="mode"
            value="send"
            class="px-3 py-2 rounded-lg bg-emerald-600 text-white"
          >
            Kirim ke Penerima
          </button>
          <p class="text-xs text-slate-500">
            Dikirim per orang (bukan BCC) agar link unsubscribe personal.
          </p>
        </div>
      </div>

      <div class="text-xs text-slate-500">
        From: <b>{{ sender_name }}</b> &lt;{{ sender_email }}&gt;
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Inisialisasi Quill
    const quill = new Quill("#editor", {
      theme: "snow",
      placeholder: "Tulis konten promo di sini...",
      modules: {
        toolbar: [
          ["bold", "italic", "underline"],
          [{ color: [] }, { background: [] }],
          [{ list: "ordered" }, { list: "bullet" }],
          ["link", "image"],
        ],
      },
    });

    // Upload gambar ke backend lalu sisipkan ke editor
    function uploadImage(file) {
      const formData = new FormData();
      formData.append("image", file);

      fetch("/upload", {
        method: "POST",
        body: formData,
      })
        .then((res) => res.json())
        .then((result) => {
          if (result && result.url) {
            document.getElementById("image_url").value = result.url;
          }
        })
        .catch((err) => {
          console.error("Upload gagal:", err);
        });
    }

    // Handler tombol "image" pada toolbar
    quill.getModule("toolbar").addHandler("image", function () {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.click();
      input.onchange = function () {
        const file = input.files && input.files[0];
        if (file) uploadImage(file);
      };
    });

    // Saat submit form, salin isi Quill ke textarea hidden
    const form = document.querySelector("form");
    if (form) {
      form.addEventListener("submit", function () {
        const hidden = document.querySelector("#body_html");
        if (hidden) hidden.value = quill.root.innerHTML;
      });
    }

    // Preview untuk #image_upload dan #image_preview
    const fileInput = document.getElementById("image_upload");
    const previewImg = document.getElementById("image_preview");
    let currentURL = null; // simpan ObjectURL agar bisa direvoke

    if (fileInput && previewImg) {
      fileInput.addEventListener("change", function (e) {
        const file = e.target.files && e.target.files[0];

        // Jika batal pilih
        if (!file) {
          if (currentURL) {
            URL.revokeObjectURL(currentURL);
            currentURL = null;
          }
          previewImg.src = "";
          previewImg.classList.add("hidden");
          return;
        }

        // Validasi tipe gambar
        if (file.type && !file.type.startsWith("image/")) {
          alert("File yang dipilih bukan gambar.");
          e.target.value = "";
          return;
        }

        // Tampilkan preview
        if (currentURL) URL.revokeObjectURL(currentURL);
        currentURL = URL.createObjectURL(file);
        previewImg.src = currentURL;
        previewImg.classList.remove("hidden");
        uploadImage(file);
      });
    }
  });
</script>
{% endblock %}
