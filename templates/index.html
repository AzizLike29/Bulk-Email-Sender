{% extends "base.html" %} {% block content %}
<div class="grid gap-6">
  <div class="p-5 bg-white border rounded-xl shadow-sm">
    <h2 class="font-semibold text-lg mb-3">Kirim Email Promosi</h2>
    <form method="post" action="/send" class="grid gap-4">
      <div class="grid gap-2">
        <label class="text-sm font-medium">Subject</label>
        <input
          name="subject"
          class="border rounded-lg p-2"
          placeholder="Promo Spesial Minggu Ini"
          required
        />
      </div>

      <div class="grid gap-2">
        <label for="image_upload" class="text-sm font-medium"
          >Upload Gambar</label
        >
        <input
          type="file"
          id="image_upload"
          accept="image/*"
          class="text-sm border border-gray-300 rounded p-1"
        />

        <img
          id="image_preview"
          alt="Preview gambar"
          class="mt-2 w-48 h-48 object-contain border rounded hidden"
        />

        <input type="hidden" name="image_url" id="image_url" />

        <label for="body_html" class="text-sm font-medium mt-2"
          >HTML Body</label
        >
        <div class="border border-gray-300 rounded-lg overflow-hidden">
          <div id="editor" class="min-h-[150px]"></div>
        </div>
        <textarea name="body_html" id="body_html" hidden></textarea>
        <p class="text-xs text-slate-500">
          Gunakan HTML sederhana. Unsubscribe ditambahkan otomatis di footer.
        </p>
      </div>

      <div class="grid gap-2">
        <label class="text-sm font-medium"
          >Manual Recipients (comma/line)</label
        >
        <textarea
          name="recipients"
          class="border rounded-lg p-2 h-24"
          placeholder="user1@example.com, user2@example.com"
        ></textarea>
      </div>

      <div class="flex items-center gap-2">
        <input
          id="use_audience"
          name="use_audience"
          type="checkbox"
          class="h-4 w-4"
        />
        <label for="use_audience" class="text-sm"
          >Tambahkan semua subscriber aktif dari database ({{ active_count }}
          orang)</label
        >
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="grid gap-2 p-3 border rounded-lg">
          <div class="text-sm font-medium">Test Send</div>
          <input
            name="test_email"
            class="border rounded-lg p-2"
            placeholder="email-kamu@contoh.com"
          />
          <button
            name="mode"
            value="test"
            class="mt-2 px-3 py-2 rounded-lg bg-slate-900 text-white"
          >
            Kirim Test
          </button>
          <p class="text-xs text-slate-500">
            Kirim hanya ke 1 alamat untuk uji coba.
          </p>
        </div>
        <div class="grid gap-2 p-3 border rounded-lg">
          <div class="text-sm font-medium">Kirim Kampanye</div>
          <button
            name="mode"
            value="send"
            class="px-3 py-2 rounded-lg bg-emerald-600 text-white"
          >
            Kirim ke Penerima
          </button>
          <p class="text-xs text-slate-500">
            Dikirim per orang (bukan BCC) agar link unsubscribe personal.
          </p>
        </div>
      </div>

      <div class="text-xs text-slate-500">
        From: <b>{{ sender_name }}</b> &lt;{{ sender_email }}&gt;
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Quill
    const quill = new Quill("#editor", {
      theme: "snow",
      placeholder: "Tulis konten promo di sini...",
      modules: {
        toolbar: [
          ["bold", "italic", "underline"],
          [{ color: [] }, { background: [] }],
          [{ list: "ordered" }, { list: "bullet" }],
          ["link", "image"],
        ],
      },
    });

    const fileInput = document.getElementById("image_upload");
    const previewImg = document.getElementById("image_preview");
    const hiddenInput = document.getElementById("image_url");
    const form = document.querySelector("form");
    let uploading = 0;

    function setSendingDisabled(disabled) {
      document.querySelectorAll('button[name="mode"]').forEach((btn) => {
        btn.disabled = disabled;
        if (disabled) {
          btn.dataset.label = btn.dataset.label || btn.textContent;
          btn.textContent = "Mengunggah gambar...";
        } else if (btn.dataset.label) {
          btn.textContent = btn.dataset.label;
        }
      });
    }

    function uploadImage(file) {
      uploading++;
      setSendingDisabled(true);

      const fd = new FormData();
      fd.append("image", file);

      return fetch("/upload", { method: "POST", body: fd })
        .then((res) => res.json())
        .then((result) => {
          if (!result || !result.url) throw new Error("Upload gagal");
          const url = result.url; // URL Cloudinary
          hiddenInput.value = url; // simpan ke form
          if (previewImg) {
            previewImg.src = url; // preview pakai URL final
            previewImg.classList.remove("hidden");
          }
          return url;
        })
        .catch((err) => {
          console.error(err);
          alert("Upload gambar gagal. Coba lagi.");
          return null;
        })
        .finally(() => {
          uploading--;
          if (uploading === 0) setSendingDisabled(false);
        });
    }

    // Handler toolbar "image" upload lalu sisipkan ke editor
    quill.getModule("toolbar").addHandler("image", function () {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = async () => {
        const file = input.files && input.files[0];
        if (!file) return;
        if (file.type && !file.type.startsWith("image/")) {
          alert("File yang dipilih bukan gambar.");
          return;
        }
        const url = await uploadImage(file);
        if (url) {
          const pos = (quill.getSelection() || { index: quill.getLength() })
            .index;
          quill.insertEmbed(pos, "image", url, "user");
          quill.setSelection(pos + 1);
        }
      };
      input.click();
    });

    // Handler input file terpisah (Preview hero image)
    if (fileInput) {
      fileInput.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) {
          previewImg.src = "";
          previewImg.classList.add("hidden");
          hiddenInput.value = "";
          return;
        }
        if (file.type && !file.type.startsWith("image/")) {
          alert("File yang dipilih bukan gambar.");
          e.target.value = "";
          return;
        }
        await uploadImage(file);
      });
    }

    // Kirim form blok kalau upload belum selesai
    if (form) {
      form.addEventListener("submit", function (e) {
        if (uploading > 0) {
          e.preventDefault();
          alert("Tunggu, gambar masih diunggahâ€¦");
          return;
        }
        // Salin HTML editor ke textarea hidden
        const hidden = document.getElementById("body_html");
        if (hidden) hidden.value = quill.root.innerHTML;
        if (fileInput && fileInput.files.length > 0 && !hiddenInput.value) {
          e.preventDefault();
          alert("Gambar belum tersimpan. Coba unggah ulang.");
        }
      });
    }
  });
</script>
{% endblock %}
