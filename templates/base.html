<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Email Blast Mini</title>
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='img/gmail.png') }}"
      type="image/x-icon"
    />
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div class="max-w-4xl mx-auto p-6">
      <header class="mb-6">
        <div class="text-center">
          <img
            src="/static/img/logo.webp"
            alt="Logo FS"
            class="mx-auto h-16 mb-2"
          />
          <p class="text-sm text-slate-500 mt-3">Flask SMTP Marketing Tool</p>
        </div>
        <nav class="mt-2 space-x-4">
          <a href="/" class="text-blue-600 hover:underline">Kirim Email</a>
          <a href="/subscribe" class="text-blue-600 hover:underline"
            >Tambah Subscriber</a
          >
        </nav>
      </header>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="space-y-2 mb-4">
        {% for category, message in messages %}
        <div
          class="p-3 rounded-lg border {% if category=='error' %}border-red-300 bg-red-50{% else %}border-emerald-300 bg-emerald-50{% endif %}"
        >
          {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}

      <main>{% block content %}{% endblock %}</main>

      <footer class="mt-10 text-xs text-slate-400">
        Demo edukasi. Patuhi aturan anti-spam & hanya kirim ke list yang opt-in.
      </footer>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Inisialisasi Quill
        var quill = new Quill("#editor", {
          theme: "snow",
          placeholder: "Tulis konten promo di sini...",
          modules: {
            toolbar: [
              ["bold", "italic", "underline"],
              [{ color: [] }, { background: [] }],
              [{ list: "ordered" }, { list: "bullet" }],
              ["link", "image"],
            ],
          },
        });

        // Upload gambar ke backend lalu sisipkan ke editor
        function uploadImage(file) {
          var formData = new FormData();
          formData.append("image", file);

          fetch("/upload", {
            method: "POST",
            body: formData,
          })
            .then(function (res) {
              return res.json();
            })
            .then(function (result) {
              var range = quill.getSelection(true) || {
                index: quill.getLength(),
              };
              if (result && result.url) {
                quill.insertEmbed(range.index, "image", result.url);
                quill.setSelection(range.index + 1);
              }
            })
            .catch(function (err) {
              console.error("Upload gagal:", err);
            });
        }

        // Handler tombol "image" pada toolbar
        quill.getModule("toolbar").addHandler("image", function () {
          var input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.click();
          input.onchange = function () {
            var file = input.files && input.files[0];
            if (file) uploadImage(file);
          };
        });

        // Saat submit form, salin isi Quill ke textarea hidden
        var form = document.querySelector("form");
        if (form) {
          form.addEventListener("submit", function () {
            var hidden = document.querySelector("#body_html");
            if (hidden) hidden.value = quill.root.innerHTML;
          });
        }
      });
    </script>
  </body>
</html>
